{% extends 'base.html' %}
{% block content %}
<div class="row mb-4">
    <div class="col">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="fas fa-chart-line"></i> Sales Funnel Dashboard</h2>
            {% if can_add %}
                <a href="{% url 'sales_funnel:add_entry' %}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add New Entry
                </a>
            {% endif %}
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Total Entries</h6>
                        <h3>{{ stats.total_entries }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-list-alt fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Total Value</h6>
                        <h3>₱{{ stats.total_value|floatformat:0 }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-money-bill-wave fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Expected Profit</h6>
                        <h3>₱{{ stats.total_profit|floatformat:0 }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-chart-pie fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-dark text-white">
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-4">
                        <small>Quoted</small><br>
                        <strong>{{ stats.quoted_count }}</strong>
                    </div>
                    <div class="col-4">
                        <small>Closable</small><br>
                        <strong>{{ stats.closable_count }}</strong>
                    </div>
                    <div class="col-4">
                        <small>Project</small><br>
                        <strong>{{ stats.project_count }}</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filter Section -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label">Stage</label>
                {{ filter_form.stage }}
            </div>
            <div class="col-md-3">
                <label class="form-label">Date From</label>
                {{ filter_form.date_from }}
            </div>
            <div class="col-md-3">
                <label class="form-label">Date To</label>
                {{ filter_form.date_to }}
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-filter"></i> Filter
                </button>
                <a href="{% url 'sales_funnel:dashboard' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-times"></i> Clear
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Funnel Tables -->
<div class="row">
    <!-- Pink Funnel: Newly Quoted -->
    <div class="col-lg-4 mb-4">
        <div class="card border-primary">
            <div class="card-header bg-pink text-white" style="background-color: #e91e63 !important;">
                <h5 class="mb-0">
                    <i class="fas fa-quote-left"></i> Newly Quoted
                    <span class="badge bg-white text-pink float-end">{{ quoted_entries.count }}</span>
                </h5>
            </div>
            <div class="card-body p-0">
                {% if quoted_entries %}
                    <div class="table-responsive">
                        <table class="table table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>Company</th>
                                    <th>Retail</th>
                                    <th>Profit</th>
                                    {% if not can_add %}<th>Salesperson</th>{% endif %}
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in quoted_entries %}
                                    <tr id="entry-{{ entry.id }}">
                                        <td><small>{{ entry.date_created|date:"M d" }}</small></td>
                                        <td>
                                            <small><strong>{{ entry.company_name|truncatechars:20 }}</strong></small><br>
                                            <small class="text-muted">{{ entry.requirement_description|truncatechars:30 }}</small>
                                        </td>
                                        <td><small>₱{{ entry.retail|floatformat:0 }}</small></td>
                                        <td><small class="{% if entry.profit > 0 %}text-success{% else %}text-danger{% endif %}">₱{{ entry.profit|floatformat:0 }}</small></td>
                                        {% if not can_add %}
                                            <td><small>{{ entry.salesperson.get_full_name|default:entry.salesperson.username }}</small></td>
                                        {% endif %}
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-warning btn-sm" onclick="moveEntry({{ entry.id }}, 'closable')" title="Move to Closable">
                                                    <i class="fas fa-arrow-right"></i>
                                                </button>
                                                <a href="{% url 'sales_funnel:edit_entry' entry.id %}" class="btn btn-outline-primary btn-sm" title="Edit">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                {% if can_add or can_edit_all %}
                                                    <button class="btn btn-outline-danger btn-sm" onclick="deleteEntry({{ entry.id }})" title="Delete">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="p-3 text-center text-muted">
                        <i class="fas fa-inbox fa-2x mb-2"></i><br>
                        No quoted entries
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Yellow Funnel: Closable This Month -->
    <div class="col-lg-4 mb-4">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fas fa-handshake"></i> Closable This Month
                    <span class="badge bg-dark float-end">{{ closable_entries.count }}</span>
                </h5>
            </div>
            <div class="card-body p-0">
                {% if closable_entries %}
                    <div class="table-responsive">
                        <table class="table table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>Company</th>
                                    <th>Retail</th>
                                    <th>Profit</th>
                                    {% if not can_add %}<th>Salesperson</th>{% endif %}
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in closable_entries %}
                                    <tr id="entry-{{ entry.id }}">
                                        <td><small>{{ entry.date_created|date:"M d" }}</small></td>
                                        <td>
                                            <small><strong>{{ entry.company_name|truncatechars:20 }}</strong></small><br>
                                            <small class="text-muted">{{ entry.requirement_description|truncatechars:30 }}</small>
                                        </td>
                                        <td><small>₱{{ entry.retail|floatformat:0 }}</small></td>
                                        <td><small class="{% if entry.profit > 0 %}text-success{% else %}text-danger{% endif %}">₱{{ entry.profit|floatformat:0 }}</small></td>
                                        {% if not can_add %}
                                            <td><small>{{ entry.salesperson.get_full_name|default:entry.salesperson.username }}</small></td>
                                        {% endif %}
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-success btn-sm" onclick="closeEntry({{ entry.id }}, true)" title="Mark as Won">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button class="btn btn-outline-danger btn-sm" onclick="closeEntry({{ entry.id }}, false)" title="Mark as Lost">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <a href="{% url 'sales_funnel:edit_entry' entry.id %}" class="btn btn-outline-primary btn-sm" title="Edit">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="p-3 text-center text-muted">
                        <i class="fas fa-inbox fa-2x mb-2"></i><br>
                        No closable entries
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Green Funnel: Project Based -->
    <div class="col-lg-4 mb-4">
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-project-diagram"></i> Project Based
                    <span class="badge bg-white text-success float-end">{{ project_entries.count }}</span>
                </h5>
            </div>
            <div class="card-body p-0">
                {% if project_entries %}
                    <div class="table-responsive">
                        <table class="table table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>Company</th>
                                    <th>Retail</th>
                                    <th>Profit</th>
                                    {% if not can_add %}<th>Salesperson</th>{% endif %}
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in project_entries %}
                                    <tr id="entry-{{ entry.id }}">
                                        <td><small>{{ entry.date_created|date:"M d" }}</small></td>
                                        <td>
                                            <small><strong>{{ entry.company_name|truncatechars:20 }}</strong></small><br>
                                            <small class="text-muted">{{ entry.requirement_description|truncatechars:30 }}</small>
                                        </td>
                                        <td><small>₱{{ entry.retail|floatformat:0 }}</small></td>
                                        <td><small class="{% if entry.profit > 0 %}text-success{% else %}text-danger{% endif %}">₱{{ entry.profit|floatformat:0 }}</small></td>
                                        {% if not can_add %}
                                            <td><small>{{ entry.salesperson.get_full_name|default:entry.salesperson.username }}</small></td>
                                        {% endif %}
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-warning btn-sm" onclick="moveEntry({{ entry.id }}, 'closable')" title="Move to Closable">
                                                    <i class="fas fa-arrow-left"></i>
                                                </button>
                                                <a href="{% url 'sales_funnel:edit_entry' entry.id %}" class="btn btn-outline-primary btn-sm" title="Edit">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                {% if can_add or can_edit_all %}
                                                    <button class="btn btn-outline-danger btn-sm" onclick="deleteEntry({{ entry.id }})" title="Delete">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="p-3 text-center text-muted">
                        <i class="fas fa-inbox fa-2x mb-2"></i><br>
                        No project entries
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for dynamic actions -->
<script>
function moveEntry(entryId, newStage) {
    if (confirm('Move this entry to ' + newStage + ' stage?')) {
        fetch(`/funnel/update-stage/${entryId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `stage=${newStage}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', data.message);
                location.reload(); // Refresh to show in new column
            } else {
                showAlert('danger', data.message);
            }
        })
        .catch(error => {
            showAlert('danger', 'An error occurred while updating the entry.');
        });
    }
}

function closeEntry(entryId, won) {
    const status = won ? 'won' : 'lost';
    if (confirm(`Mark this deal as ${status}?`)) {
        fetch(`/funnel/close/${entryId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `won=${won}`
        })
        .then(response => {
            if (response.redirected) {
                location.reload();
            }
        })
        .catch(error => {
            showAlert('danger', 'An error occurred while closing the entry.');
        });
    }
}

function deleteEntry(entryId) {
    if (confirm('Are you sure you want to delete this funnel entry? This action cannot be undone.')) {
        fetch(`/funnel/delete/${entryId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            }
        })
        .then(response => {
            if (response.redirected) {
                location.reload();
            }
        })
        .catch(error => {
            showAlert('danger', 'An error occurred while deleting the entry.');
        });
    }
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>

{% csrf_token %}
{% endblock %}
